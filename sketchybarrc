# Sketchybar configuration with Rust helper daemon
# The daemon handles all plugin logic for better performance

CLI_BIN="$HOME/.local/bin/sketchycli"
BARTENDER_BIN="$HOME/.local/bin/sketchybartender"
BOUNCER_BIN="$HOME/.local/bin/sketchybarbouncer"

##### Start Helper Daemon #####
# Kill any existing helper and start fresh
pkill -f sketchybartender 2>/dev/null
pkill -f sketchybarbouncer 2>/dev/null
"$BARTENDER_BIN" &
"$BOUNCER_BIN" &

# Give daemon time to initialize
sleep 0.2

##### Bar Appearance #####
sketchybar --bar position=top height=32 blur_radius=0 color=0x40000000 margin=0

##### Changing Defaults #####
default=(
  padding_left=0
  padding_right=5
  icon.font="Hack Nerd Font:Bold:17.0"
  label.font="Hack Nerd Font:Bold:14.0"
  icon.color=0xffffffff
  label.color=0xffffffff
  icon.padding_left=4
  icon.padding_right=4
  label.padding_left=4
  label.padding_right=4
)
sketchybar --default "${default[@]}"

##### Adding AeroSpace Workspace Indicator #####
# Workspace updates are now handled directly by aerospace → sketchybartender
# No need for sketchybar event subscriptions

# Add workspace items for workspaces 1-9 (no subscriptions, updated by workspace_manager)
for workspace in {1..9}; do
    sketchybar --add item "workspace.$workspace" left \
        --set "workspace.$workspace" \
        icon.font="sketchybar-app-font:Regular:13.0" \
        label.font="Hack Nerd Font:Bold:14.0" \
        background.corner_radius=10 \
        background.height=28 \
        background.drawing=off \
        padding_left=4 \
        padding_right=2 \
        icon.padding_left=8 \
        icon.padding_right=4 \
        label.padding_left=4 \
        label.padding_right=10 \
        drawing=off \
        click_script="$CLI_BIN on-workspace-clicked"
done

##### Adding Left Items #####
# Front app updates are now handled directly by aerospace → sketchybartender
sketchybar --add item front_app left \
           --set front_app \
           icon.font="sketchybar-app-font:Regular:16.0" \
           label.font="Hack Nerd Font:Bold:14.0" \
           icon.drawing=off \
           padding_left=10

##### Adding Right Items #####
# Clock, battery, brew, and teams are now updated automatically by sketchybartender
# Update intervals can be configured in ~/.config/sketchybar/sketchybartenderrc
sketchybar --add item clock right \
           --set clock padding_left=0 padding_right=0 \
           --add item volume right \
           --set volume script="$CLI_BIN on-volume-change" \
           --subscribe volume volume_change \
           --add item battery right \
           --subscribe battery system_woke power_source_change \
           --add item brew right \
           --set brew click_script="$CLI_BIN on-brew-clicked" \
           --subscribe brew mouse.clicked \
           --add item teams right \
           --set teams icon="󰊻" icon.color=0xffffffff \
           background.border_color=0xff2a2c3a background.border_width=1 \
           background.corner_radius=5 background.height=22 \
           click_script="$CLI_BIN on-teams-clicked" \
           --subscribe teams mouse.clicked

##### Force all scripts to run the first time #####
sketchybar --update
